<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Eventos (PWA Mode)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .hidden { display: none !important; }
        .offline-banner { background: #dc3545; color: white; text-align: center; padding: 5px; display: none; font-weight: bold;}
        .sync-badge { position: absolute; top: -5px; right: -5px; }
    </style>
</head>
<body>

<div id="offline-indicator" class="offline-banner">‚ö†Ô∏è MODO OFFLINE ATIVADO - DADOS SALVOS LOCALMENTE</div>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">üéì Sistema deEventos </h2>
        <div id="user-info" class="d-flex align-items-center gap-3 hidden">
            <span>Ol√°, <b id="user-name">User</b></span>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">Sair</button>
        </div>
    </div>

    <div id="auth-screen" class="row justify-content-center">
        <div class="col-md-5">
            <div class="card p-4">
                <h4 class="text-center mb-3" id="auth-title">Login</h4>
                
                <div id="register-fields" class="hidden">
                    <input type="text" id="reg-name" class="form-control mb-2" placeholder="Nome Completo">
                </div>

                <input type="email" id="email" class="form-control mb-2" placeholder="Email">
                <input type="password" id="password" class="form-control mb-3" placeholder="Senha">
                
                <button onclick="handleAuth()" id="btn-auth" class="btn btn-primary w-100">Entrar</button>
                
                <div class="text-center mt-3">
                    <a href="#" onclick="toggleAuthMode()" id="toggle-auth-link">N√£o tem conta? Cadastre-se</a>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        
        <ul class="nav nav-pills mb-3" id="mainTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" onclick="switchTab('eventos')">üìÖ Eventos</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchTab('inscricoes')">üé´ Minhas Inscri√ß√µes</button>
            </li>
            <li class="nav-item hidden" id="tab-admin">
                <button class="nav-link bg-dark text-white position-relative" onclick="switchTab('admin')">
                    üõ°Ô∏è √Årea do Atendente
                    <span id="sync-count" class="badge rounded-pill bg-danger sync-badge hidden">0</span>
                </button>
            </li>
        </ul>

        <div id="view-eventos" class="view-section">
            <div id="lista-eventos" class="row">
                <p class="text-muted text-center">Carregando eventos...</p>
            </div>
        </div>

        <div id="view-inscricoes" class="view-section hidden">
            <div class="card p-3">
                <h5>Minhas Inscri√ß√µes & Certificados</h5>
                <button onclick="carregarMinhasInscricoes()" class="btn btn-sm btn-light w-25 mb-3">Atualizar</button>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead><tr><th>Evento</th><th>Data</th><th>Status</th><th>A√ß√£o</th></tr></thead>
                        <tbody id="tbody-inscricoes"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-section hidden">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-3 mb-3 border-danger">
                        <h5 class="text-danger">üì° Controle de Portaria (Offline Capable)</h5>
                        <p class="small text-muted">Use esta √°rea para check-in e cadastros r√°pidos na porta.</p>
                        
                        <div class="d-grid gap-2 mb-3">
                             <button onclick="sincronizarDados()" id="btn-sync" class="btn btn-secondary" disabled>
                                üîÑ Sincronizar com Servidor
                             </button>
                             <button onclick="atualizarCacheAdmin()" class="btn btn-outline-primary btn-sm">
                                ‚¨áÔ∏è Baixar Dados para Cache Local
                             </button>
                        </div>
                        
                        <hr>

                        <h6>üìç Registrar Presen√ßa (Check-in)</h6>
                        <select id="admin-evento-select" class="form-select mb-2"></select>
                        
                        <input list="users-datalist" id="admin-user-input" class="form-control mb-2" placeholder="Buscar Participante (Nome ou Email)...">
                        <datalist id="users-datalist"></datalist>

                        <button onclick="adminCheckIn()" class="btn btn-success w-100 mb-4">‚úÖ Confirmar Presen√ßa</button>

                        <hr>

                        <h6>üìù Cadastro R√°pido (Novo Participante)</h6>
                        <input type="text" id="quick-name" class="form-control mb-2" placeholder="Nome">
                        <input type="email" id="quick-email" class="form-control mb-2" placeholder="Email">
                        <button onclick="adminQuickRegister()" class="btn btn-primary w-100">Cadastrar e Selecionar</button>

                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card p-3 bg-light">
                        <h6>üóÉÔ∏è Fila de Sincroniza√ß√£o (Local)</h6>
                        <ul id="sync-queue-list" class="list-group small" style="max-height: 400px; overflow-y: auto;">
                            <li class="list-group-item text-muted">Fila vazia.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const API_URL = "http://localhost:8080";
    
    // --- ESTADO GLOBAL ---
    let currentUser = null;
    let token = localStorage.getItem("token");
    let isRegisterMode = false;
    
    // Cache Local (Simula√ß√£o de Banco Local)
    let localUsers = JSON.parse(localStorage.getItem("cache_users")) || [];
    let localEvents = JSON.parse(localStorage.getItem("cache_events")) || [];
    let syncQueue = JSON.parse(localStorage.getItem("sync_queue")) || [];
    // NOVO: Cache de Inscri√ß√µes. Estrutura: { 'id-evento': [ { userId: 1, registrationId: 'uuid', presente: false }, ... ] }
    let localRegistrations = JSON.parse(localStorage.getItem("cache_registrations")) || {}; 

    // --- INICIALIZA√á√ÉO ---
    checkLogin();
    updateNetworkStatus();
    renderQueue();

    // Event Listeners para Rede
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);

    function updateNetworkStatus() {
        const indicator = document.getElementById("offline-indicator");
        const btnSync = document.getElementById("btn-sync");
        
        if (navigator.onLine) {
            indicator.style.display = "none";
            btnSync.disabled = syncQueue.length === 0;
            if(syncQueue.length > 0) btnSync.classList.replace("btn-secondary", "btn-warning");
        } else {
            indicator.style.display = "block";
            btnSync.disabled = true;
            btnSync.innerText = "Sem Conex√£o (Aguardando...)";
        }
    }

    // --- AUTENTICA√á√ÉO ---
    function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        document.getElementById("register-fields").classList.toggle("hidden");
        document.getElementById("auth-title").innerText = isRegisterMode ? "Novo Cadastro" : "Login";
        document.getElementById("btn-auth").innerText = isRegisterMode ? "Cadastrar" : "Entrar";
        document.getElementById("toggle-auth-link").innerText = isRegisterMode ? "J√° tenho conta" : "N√£o tem conta? Cadastre-se";
    }

    async function handleAuth() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const name = document.getElementById("reg-name").value;

        try {
            if (isRegisterMode) {
                const resp = await fetch(`${API_URL}/users`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // CORRE√á√ÉO AQUI: Mapeando 'name' (vari√°vel JS) para 'nome' (propriedade Java)
                    body: JSON.stringify({ nome: name, email, password, role: "ADMIN" }) 
                });
                if(!resp.ok) throw new Error("Erro no cadastro");
                alert("Cadastrado! Fa√ßa login.");
                toggleAuthMode();
            } else {
                const resp = await fetch(`${API_URL}/auth`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                if(!resp.ok) throw new Error("Login falhou");
                
                const data = await resp.json();
                localStorage.setItem("token", data.token);
                token = data.token;
                location.reload();
            }
        } catch (e) {
            alert(e.message);
        }
    }

    function parseJwt(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch (e) { return null; }
    }

    function checkLogin() {
        if (!token) return;
        
        const payload = parseJwt(token);
        currentUser = { 
            id: payload.id, 
            name: payload.sub.split('@')[0], 
            email: payload.sub,
            // HACK: Se o backend n√£o retornar role, assumimos admin se o email come√ßar com 'admin'
            // Na apresenta√ß√£o, crie um usu√°rio 'admin@evento.com'
            role: payload.roles || (payload.sub.includes('admin') ? "ADMIN" : "PARTICIPANTE") 
        };

        document.getElementById("auth-screen").classList.add("hidden");
        document.getElementById("dashboard-screen").classList.remove("hidden");
        document.getElementById("user-info").classList.remove("hidden");
        document.getElementById("user-name").innerText = currentUser.name;

        // Se for Admin, mostra aba e carrega dados
        if (currentUser.role.includes("ADMIN")) {
            document.getElementById("tab-admin").classList.remove("hidden");
            // Carrega dropdowns do admin com cache local
            populateAdminDropdowns();
        }

        carregarEventos();
    }

    function logout() {
        localStorage.removeItem("token");
        location.reload();
    }

    function switchTab(tab) {
        document.querySelectorAll(".view-section").forEach(el => el.classList.add("hidden"));
        document.getElementById(`view-${tab}`).classList.remove("hidden");
        
        document.querySelectorAll(".nav-link").forEach(el => el.classList.remove("active"));
        event.target.classList.add("active");

        if(tab === 'inscricoes') carregarMinhasInscricoes();
    }

    // --- DADOS E EVENTOS (Fluxo Normal) ---
    async function carregarEventos() {
        try {
            // Tenta pegar da API, se falhar pega do cache
            let eventos = [];
            try {
                const res = await fetch(`${API_URL}/eventos`);
                if(res.ok) {
                    eventos = await res.json();
                    localStorage.setItem("cache_events", JSON.stringify(eventos)); // Atualiza cache
                    localEvents = eventos;
                }
            } catch(e) { console.log("Usando cache eventos"); eventos = localEvents; }

            const div = document.getElementById("lista-eventos");
            div.innerHTML = "";
            
            eventos.forEach(ev => {
                div.innerHTML += `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${ev.titulo || ev.title}</h5>
                                <p class="card-text text-muted">üìÖ ${ev.data || 'Data a definir'}</p>
                                <button onclick="inscrever(${ev.id})" class="btn btn-outline-primary w-100">Inscrever-se</button>
                            </div>
                        </div>
                    </div>`;
            });
            // Atualiza tamb√©m o dropdown do admin
            populateAdminDropdowns();
        } catch (e) { console.error(e); }
    }

    async function inscrever(eventoId) {
        if(!confirm("Confirmar inscri√ß√£o?")) return;
        
        const payload = { eventoId, userId: currentUser.id }; // userId pode ser redundante se o back pegar do token
        
        if (navigator.onLine) {
            const res = await fetch(`${API_URL}/inscricoes`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify({ eventoId })
            });
            if(res.ok) alert("Inscrito com sucesso!");
            else alert("Erro ao inscrever.");
        } else {
            // Se for um participante tentando se inscrever offline (raro, mas poss√≠vel app PWA)
            alert("Voc√™ est√° offline. A√ß√£o n√£o permitida para participantes comuns.");
        }
    }

    async function carregarMinhasInscricoes() {
        const tbody = document.getElementById("tbody-inscricoes");
        tbody.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
        
        try {
            const res = await fetch(`${API_URL}/inscricoes`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            const dados = await res.json();
            
            tbody.innerHTML = "";
            dados.forEach(ins => {
                // Tenta achar nome do evento no cache local
                const evt = localEvents.find(e => e.id == ins.eventoId) || { titulo: `Evento ID ${ins.eventoId}` };
                
                let btn = `<span class="badge bg-warning text-dark">Aguardando Check-in</span>`;
                if(ins.presente) {
                    btn = `<button class="btn btn-success btn-sm" onclick="alert('Certificado gerado! ID: ${ins.id}')">üèÜ Certificado</button>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${evt.titulo || evt.title}</td>
                        <td>${new Date(ins.dataInscricao).toLocaleDateString()}</td>
                        <td>${ins.presente ? '‚úÖ Presente' : 'üïí Pendente'}</td>
                        <td>${btn}</td>
                    </tr>
                `;
            });
        } catch (e) {
            tbody.innerHTML = "<tr><td colspan='4' class='text-danger'>Erro ao carregar (Offline?)</td></tr>";
        }
    }

    // --- L√ìGICA DO ADMIN / OFFLINE (O CORA√á√ÉO DA TAREFA) ---

    async function atualizarCacheAdmin() {
        if(!navigator.onLine) return alert("Precisa estar online para baixar dados.");
        try {
            // Baixa Usu√°rios
            const r1 = await fetch(`${API_URL}/users`, { headers: { "Authorization": `Bearer ${token}` } });
            localUsers = await r1.json();
            localStorage.setItem("cache_users", JSON.stringify(localUsers));

            // Baixa Eventos (j√° temos fun√ß√£o, mas refor√ßa)
            carregarEventos(); 

            // NOVO: Baixar TODAS as Inscri√ß√µes para cache
            // Assumindo que a rota para todas as inscri√ß√µes √© /inscricoes/all
            const r2 = await fetch(`${API_URL}/inscricoes/all`, { 
                headers: { "Authorization": `Bearer ${token}` } 
            });
            const registrations = await r2.json(); 
            
            // Mapear inscri√ß√µes por evento { 'id-evento': [ { userId: 1, registrationId: 'uuid', presente: false }, ... ] }
            const newLocalRegistrations = {};
            registrations.forEach(reg => {
                const eventIdKey = reg.eventoId; // Ajuste o campo conforme o retorno real do seu backend
                if (!newLocalRegistrations[eventIdKey]) {
                    newLocalRegistrations[eventIdKey] = [];
                }
                newLocalRegistrations[eventIdKey].push(reg);
            });

            localRegistrations = newLocalRegistrations;
            localStorage.setItem("cache_registrations", JSON.stringify(localRegistrations));
            
            alert(`Cache Atualizado!\n${localUsers.length} Usu√°rios\n${localEvents.length} Eventos\n${registrations.length} Inscri√ß√µes`);
            populateAdminDropdowns();
        } catch(e) { alert("Erro ao baixar dados: " + e.message); }
    }

    function populateAdminDropdowns() {
        // Dropdown Eventos
        const selEvent = document.getElementById("admin-evento-select");
        selEvent.innerHTML = localEvents.map(e => `<option value="${e.id}">${e.titulo || e.title}</option>`).join('');

        // Datalist Usu√°rios
        const dlUsers = document.getElementById("users-datalist");
        dlUsers.innerHTML = localUsers.map(u => `<option value="${u.id} - ${u.name} (${u.email})">`).join('');
    }

    // A√ß√£o 1: Cadastrar R√°pido (Offline)
    function adminQuickRegister() {
        const name = document.getElementById("quick-name").value;
        const email = document.getElementById("quick-email").value;
        if(!name || !email) return alert("Preencha nome e email");

        // Cria ID Tempor√°rio
        const tempId = "temp_" + Date.now();
        const newUser = { id: tempId, name, email, password: "123", role: "PARTICIPANTE" };

        // Adiciona √† fila de sincroniza√ß√£o
        addToQueue({
            type: "REGISTER",
            data: newUser,
            desc: `Cadastro: ${name}`
        });

        // Adiciona ao cache local imediatamente para poder usar no check-in
        localUsers.push(newUser);
        populateAdminDropdowns();
        
        // Auto-preenche o campo de busca com o novo usu√°rio
        document.getElementById("admin-user-input").value = `${newUser.id} - ${newUser.name} (${newUser.email})`;
        
        alert("Usu√°rio salvo localmente! (ID Provis√≥rio gerado)");
        document.getElementById("quick-name").value = "";
        document.getElementById("quick-email").value = "";
    }

    // A√ß√£o 2: Check-in (Pode ser Offline)
    function adminCheckIn() {
        const eventoId = document.getElementById("admin-evento-select").value;
        const userInput = document.getElementById("admin-user-input").value;
        
        // Extrai o ID do input (formato "123 - Nome...")
        const userId = userInput.split(" - ")[0];

        if(!userId || !eventoId) return alert("Selecione evento e usu√°rio");

        // NOVO: 1. Verifica se o usu√°rio J√Å est√° registrado/presente para o evento (localmente)
        const eventRegistrations = localRegistrations[eventoId] || [];
        // Assumindo que a propriedade 'presente' existe na Registration e √© booleana
        const existingRegistration = eventRegistrations.find(reg => reg.userId == userId);

        if (existingRegistration && existingRegistration.presente) {
            return alert("Erro: Participante j√° fez check-in (Verificado no cache local).");
        }

        // Verifica se √© ID tempor√°rio
        const isTemp = userId.startsWith("temp_");

        addToQueue({
            type: "CHECKIN",
            data: { eventoId, userId },
            dependsOnUser: isTemp ? userId : null, // Se for temp, check-in depende do cadastro
            desc: `Check-in: User ${userId} no Evento ${eventoId}`
        });

        alert("Presen√ßa registrada na fila!");
        document.getElementById("admin-user-input").value = "";
    }

    // Gerenciamento da Fila
    function addToQueue(item) {
        syncQueue.push(item);
        saveQueue();
    }

    function saveQueue() {
        localStorage.setItem("sync_queue", JSON.stringify(syncQueue));
        renderQueue();
        updateNetworkStatus();
    }

    function renderQueue() {
        const list = document.getElementById("sync-queue-list");
        const badge = document.getElementById("sync-count");
        
        list.innerHTML = "";
        badge.innerText = syncQueue.length;
        badge.classList.toggle("hidden", syncQueue.length === 0);

        if(syncQueue.length === 0) {
            list.innerHTML = `<li class="list-group-item text-muted">Nada pendente.</li>`;
            return;
        }

        syncQueue.forEach((item, idx) => {
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${item.desc}</span>
                    <span class="badge bg-secondary">${item.type}</span>
                </li>`;
        });
    }

    // --- SINCRONIZA√á√ÉO (A m√°gica acontece aqui) ---
    async function sincronizarDados() {
        if (syncQueue.length === 0) return alert("Nada para sincronizar.");
        
        const btn = document.getElementById("btn-sync");
        btn.disabled = true;
        btn.innerText = "Sincronizando...";

        // Mapa para traduzir IDs tempor√°rios -> IDs reais do banco
        // Ex: { "temp_123": 55 }
        let idMap = {}; 
        let failedItems = [];

        for (const item of syncQueue) {
            try {
                // 1. Resolve dependencia de ID se houver
                if (item.dependsOnUser && idMap[item.dependsOnUser]) {
                    item.data.userId = idMap[item.dependsOnUser];
                }

                // 2. Executa a A√ß√£o
                if (item.type === "REGISTER") {
                    console.log("Enviando cadastro...", item.data);
                    // Remove o ID temp antes de enviar pro banco
                    const { id, ...payload } = item.data; 
                    
                    const res = await fetch(`${API_URL}/users`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!res.ok) throw new Error("Falha ao criar user");
                    const createdUser = await res.json();
                    
                    // Mapeia Temp ID -> Real ID
                    idMap[item.data.id] = createdUser.id;
                    console.log(`Mapeado: ${item.data.id} -> ${createdUser.id}`);

                } else if (item.type === "CHECKIN") {
                    console.log("Enviando checkin...", item.data);
                    
                    // Primeiro, garante a inscri√ß√£o (regra do sistema: checkin requer inscri√ß√£o)
                    // Tentamos inscrever silenciosamente antes do checkin
                    await fetch(`${API_URL}/inscricoes`, {
                         method: "POST",
                         headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                         body: JSON.stringify({ eventoId: item.data.eventoId, userId: item.data.userId }) // Assumindo que endpoint aceita userId no body se for admin
                    }).catch(() => {}); // Ignora erro se j√° inscrito

                    // Agora o Check-in
                    const res = await fetch(`${API_URL}/inscricoes/presenca`, { // Ajuste sua rota se for /presencas
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                        body: JSON.stringify({ eventoId: item.data.eventoId, userId: item.data.userId }) // O endpoint precisa suportar receber userId expl√≠cito
                    });

                    if(!res.ok) throw new Error("Falha no checkin");
                }

            } catch (error) {
                console.error("Erro na sync:", error);
                item.error = error.message;
                failedItems.push(item);
            }
        }

        // Limpa e atualiza fila
        syncQueue = failedItems;
        saveQueue();
        
        btn.disabled = false;
        btn.innerText = "üîÑ Sincronizar com Servidor";
        
        if (failedItems.length === 0) {
            alert("‚úÖ Sincroniza√ß√£o completa com sucesso!");
            atualizarCacheAdmin(); // Atualiza dados locais com os novos IDs reais
        } else {
            alert(`‚ö†Ô∏è Sincroniza√ß√£o terminou com ${failedItems.length} erros. Verifique o console.`);
        }
    }
    
    // --- REGISTRO DO SERVICE WORKER (PWA Offline) ---
    // Voc√™ precisa criar um arquivo sw.js no mesmo diret√≥rio
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registrado com sucesso:', registration);
                })
                .catch(error => {
                    console.log('Falha no registro do Service Worker:', error);
                });
        });
    }
</script>

</body>
</html>