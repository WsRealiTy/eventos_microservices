<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Eventos (PWA Mode)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .hidden { display: none !important; }
        .offline-banner { background: #dc3545; color: white; text-align: center; padding: 5px; display: none; font-weight: bold;}
        .sync-badge { position: absolute; top: -5px; right: -5px; }
    </style>
</head>
<body>

<div id="offline-indicator" class="offline-banner">MODO OFFLINE ATIVADO - DADOS SALVOS LOCALMENTE</div>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">Sistema de Eventos</h2>
        <div id="user-info" class="d-flex align-items-center gap-3 hidden">
            <span>Olá, <b id="user-name">User</b></span>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">Sair</button>
        </div>
    </div>

    <div id="auth-screen" class="row justify-content-center">
        <div class="col-md-5">
            <div class="card p-4">
                <h4 class="text-center mb-3" id="auth-title">Login</h4>
                
                <div id="register-fields" class="hidden">
                    <input type="text" id="reg-name" class="form-control mb-2" placeholder="Nome Completo">
                </div>

                <input type="email" id="email" class="form-control mb-2" placeholder="Email">
                <input type="password" id="password" class="form-control mb-3" placeholder="Senha">
                
                <button onclick="handleAuth()" id="btn-auth" class="btn btn-primary w-100">Entrar</button>
                
                <div class="text-center mt-3">
                    <a href="#" onclick="toggleAuthMode()" id="toggle-auth-link">Não tem conta? Cadastre-se</a>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        
        <ul class="nav nav-pills mb-3" id="mainTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" onclick="switchTab('eventos')">Eventos</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchTab('inscricoes')">Minhas Inscrições</button>
            </li>
            <li class="nav-item hidden" id="tab-admin">
                <button class="nav-link bg-dark text-white position-relative" onclick="switchTab('admin')">
                    Área do Atendente
                    <span id="sync-count" class="badge rounded-pill bg-danger sync-badge hidden">0</span>
                </button>
            </li>
        </ul>

        <div id="view-eventos" class="view-section">
            <div id="lista-eventos" class="row">
                <p class="text-muted text-center">Carregando eventos...</p>
            </div>
        </div>

        <div id="view-inscricoes" class="view-section hidden">
            <div class="card p-3">
                <h5>Minhas Inscrições & Certificados</h5>
                <button onclick="carregarMinhasInscricoes()" class="btn btn-sm btn-light w-25 mb-3">Atualizar</button>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead><tr><th>Evento</th><th>Data</th><th>Status</th><th>Ação</th></tr></thead>
                        <tbody id="tbody-inscricoes"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view-section hidden">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-3 mb-3 border-danger">
                        <h5 class="text-danger">Controle de Portaria (Offline Capable)</h5>
                        <p class="small text-muted">Use esta área para check-in e cadastros rápidos na porta.</p>
                        
                        <div class="d-grid gap-2 mb-3">
                             <button onclick="sincronizarDados()" id="btn-sync" class="btn btn-secondary" disabled>
                                Sincronizar com Servidor
                             </button>
                             <button onclick="atualizarCacheAdmin()" class="btn btn-outline-primary btn-sm">
                                Baixar Dados para Cache Local
                             </button>
                        </div>
                        
                        <hr>

                        <h6>Registrar Presença (Check-in)</h6>
                        <select id="admin-evento-select" class="form-select mb-2"></select>
                        
                        <input list="users-datalist" id="admin-user-input" class="form-control mb-2" placeholder="Buscar Participante (Nome ou Email)...">
                        <datalist id="users-datalist"></datalist>

                        <button onclick="adminCheckIn()" class="btn btn-success w-100 mb-4">Confirmar Presença</button>

                        <hr>

                        <h6>Cadastro Rápido (Novo Participante)</h6>
                        <input type="text" id="quick-name" class="form-control mb-2" placeholder="Nome">
                        <input type="email" id="quick-email" class="form-control mb-2" placeholder="Email">
                        <button onclick="adminQuickRegister()" class="btn btn-primary w-100">Cadastrar e Selecionar</button>

                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card p-3 bg-light">
                        <h6>Fila de Sincronização (Local)</h6>
                        <ul id="sync-queue-list" class="list-group small" style="max-height: 400px; overflow-y: auto;">
                            <li class="list-group-item text-muted">Fila vazia.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const API_URL = "http://localhost:8080";
    
    // --- ESTADO GLOBAL ---
    let currentUser = null;
    let token = localStorage.getItem("token");
    let isRegisterMode = false;
    
    // Cache Local
    let localUsers = JSON.parse(localStorage.getItem("cache_users")) || [];
    let localEvents = JSON.parse(localStorage.getItem("cache_events")) || [];
    let syncQueue = JSON.parse(localStorage.getItem("sync_queue")) || [];
    let localRegistrations = JSON.parse(localStorage.getItem("cache_registrations")) || {}; 

    // --- INICIALIZAÇÃO ---
    if(token) checkLogin();
    updateNetworkStatus();
    renderQueue();

    // Event Listeners para Rede
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);

    function updateNetworkStatus() {
        const indicator = document.getElementById("offline-indicator");
        const btnSync = document.getElementById("btn-sync");
        
        if (navigator.onLine) {
            indicator.style.display = "none";
            btnSync.disabled = syncQueue.length === 0;
            if(syncQueue.length > 0) btnSync.classList.replace("btn-secondary", "btn-warning");
        } else {
            indicator.style.display = "block";
            btnSync.disabled = true;
            btnSync.innerText = "Sem Conexão (Aguardando...)";
        }
    }

    // --- AUTENTICAÇÃO ---
    function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        document.getElementById("register-fields").classList.toggle("hidden");
        document.getElementById("auth-title").innerText = isRegisterMode ? "Novo Cadastro" : "Login";
        document.getElementById("btn-auth").innerText = isRegisterMode ? "Cadastrar" : "Entrar";
        document.getElementById("toggle-auth-link").innerText = isRegisterMode ? "Já tenho conta" : "Não tem conta? Cadastre-se";
    }

    async function handleAuth() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const name = document.getElementById("reg-name").value;

        try {
            if (isRegisterMode) {
                const resp = await fetch(`${API_URL}/users`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ nome: name, email, password, role: "PARTICIPANTE" }) 
                });
                if(!resp.ok) throw new Error("Erro no cadastro");
                alert("Cadastrado! Faça login.");
                toggleAuthMode();
            } else {
                const resp = await fetch(`${API_URL}/auth`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                if(!resp.ok) throw new Error("Login falhou");
                
                const data = await resp.json();
                localStorage.setItem("token", data.token);
                token = data.token;
                location.reload();
            }
        } catch (e) {
            alert(e.message);
        }
    }

    function parseJwt(token) {
        try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
    }

    function checkLogin() {
        if (!token) return;
        
        const payload = parseJwt(token);
        if(!payload) { logout(); return; }

        currentUser = { 
            id: payload.id, 
            name: payload.sub ? payload.sub.split('@')[0] : "Usuario", 
            email: payload.sub,
            role: (payload.roles && payload.roles.includes('ADMIN')) || (payload.sub && payload.sub.includes('admin')) ? "ADMIN" : "PARTICIPANTE" 
        };

        document.getElementById("auth-screen").classList.add("hidden");
        document.getElementById("dashboard-screen").classList.remove("hidden");
        document.getElementById("user-info").classList.remove("hidden");
        document.getElementById("user-name").innerText = currentUser.name;

        if (currentUser.role === "ADMIN") {
            document.getElementById("tab-admin").classList.remove("hidden");
            populateAdminDropdowns();
        }

        carregarEventos();
    }

    function logout() {
        localStorage.removeItem("token");
        location.reload();
    }

    function switchTab(tab) {
        document.querySelectorAll(".view-section").forEach(el => el.classList.add("hidden"));
        document.getElementById(`view-${tab}`).classList.remove("hidden");
        document.querySelectorAll(".nav-link").forEach(el => el.classList.remove("active"));
        event.target.classList.add("active");
        if(tab === 'inscricoes') carregarMinhasInscricoes();
    }

    // --- EVENTOS ---
    async function carregarEventos() {
        try {
            let eventos = [];
            if (navigator.onLine) {
                const res = await fetch(`${API_URL}/eventos`);
                if(res.ok) {
                    eventos = await res.json();
                    localStorage.setItem("cache_events", JSON.stringify(eventos)); 
                    localEvents = eventos;
                }
            } else {
                eventos = localEvents;
            }

            const div = document.getElementById("lista-eventos");
            div.innerHTML = "";
            eventos.forEach(ev => {
                div.innerHTML += `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 border-primary">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${ev.titulo || ev.title}</h5>
                                <p class="card-text text-muted">Data: ${ev.data || 'Data a definir'}</p>
                                <button onclick="inscrever(${ev.id})" class="btn btn-outline-primary w-100">Inscrever-se</button>
                            </div>
                        </div>
                    </div>`;
            });
            populateAdminDropdowns();
        } catch (e) { console.error(e); }
    }

    async function inscrever(eventoId) {
        if(!confirm("Confirmar inscrição?")) return;
        if (navigator.onLine) {
            try {
                const res = await fetch(`${API_URL}/inscricoes`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ eventoId })
                });
                if(res.ok || res.status === 400) alert("Inscrito (ou já existente).");
                else alert("Erro ao inscrever.");
            } catch(e) { alert("Erro de rede."); }
        } else {
            alert("Offline: Ação não permitida para participantes.");
        }
    }

    async function carregarMinhasInscricoes() {
        const tbody = document.getElementById("tbody-inscricoes");
        tbody.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
        try {
            const res = await fetch(`${API_URL}/inscricoes`, { headers: { "Authorization": `Bearer ${token}` } });
            if(!res.ok) throw new Error("Erro");
            const dados = await res.json();
            tbody.innerHTML = "";
            dados.forEach(ins => {
                const evt = localEvents.find(e => e.id == ins.eventoId) || { titulo: `ID ${ins.eventoId}` };
                let btn = ins.presente ? `<span class="badge bg-success">Certificado</span>` : `<span class="badge bg-warning text-dark">Pendente</span>`;
                tbody.innerHTML += `<tr><td>${evt.titulo || evt.title}</td><td>-</td><td>${ins.presente ? 'Presente' : 'Pendente'}</td><td>${btn}</td></tr>`;
            });
        } catch (e) { tbody.innerHTML = "<tr><td colspan='4'>Erro ao carregar.</td></tr>"; }
    }

    // --- ADMIN / OFFLINE ---

    async function atualizarCacheAdmin() {
        if(!navigator.onLine) return alert("Fique online para baixar dados.");
        try {
            // 1. Users
            const r1 = await fetch(`${API_URL}/users`, { headers: { "Authorization": `Bearer ${token}` } });
            if(r1.ok) {
                localUsers = await r1.json();
                localStorage.setItem("cache_users", JSON.stringify(localUsers));
            }
            // 2. Eventos
            carregarEventos();
            // 3. Inscricoes (Se endpoint existir)
            const r2 = await fetch(`${API_URL}/inscricoes/all`, { headers: { "Authorization": `Bearer ${token}` } });
            if(r2.ok) {
                const regs = await r2.json();
                // Indexar por evento
                const map = {};
                regs.forEach(r => {
                    if(!map[r.eventoId]) map[r.eventoId] = [];
                    map[r.eventoId].push(r);
                });
                localRegistrations = map;
                localStorage.setItem("cache_registrations", JSON.stringify(localRegistrations));
                alert("Dados baixados com sucesso!");
            } else {
                console.warn("Rota /inscricoes/all falhou. Modo offline parcial.");
                alert("Dados parciais atualizados.");
            }
            populateAdminDropdowns();
        } catch(e) { alert("Erro de rede: " + e.message); }
    }

    function populateAdminDropdowns() {
        const sel = document.getElementById("admin-evento-select");
        if(localEvents.length) sel.innerHTML = localEvents.map(e => `<option value="${e.id}">${e.titulo || e.title}</option>`).join('');
        const dl = document.getElementById("users-datalist");
        if(localUsers.length) dl.innerHTML = localUsers.map(u => `<option value="${u.id} - ${u.name} (${u.email})">`).join('');
    }

    function adminCheckIn() {
        const eventoId = document.getElementById("admin-evento-select").value;
        const input = document.getElementById("admin-user-input").value;
        const userId = input.split(" - ")[0];

        if(!userId || !eventoId) return alert("Selecione evento e usuário.");

        // Validar no cache se já está presente
        const regs = localRegistrations[eventoId] || [];
        const existing = regs.find(r => r.userId == userId);
        if(existing && existing.presente) {
            if(!confirm("Usuário já consta como presente no cache. Registrar novamente?")) return;
        }

        const isTemp = userId.toString().startsWith("temp_");

        addToQueue({
            type: "CHECKIN",
            data: { eventoId, userId },
            dependsOnUser: isTemp ? userId : null,
            desc: `Check-in: User ${userId} -> Evento ${eventoId}`
        });
        
        alert("Check-in na fila!");
        document.getElementById("admin-user-input").value = "";
    }

    function adminQuickRegister() {
        const name = document.getElementById("quick-name").value;
        const email = document.getElementById("quick-email").value;
        if(!name || !email) return alert("Preencha dados.");

        const tempId = "temp_" + Date.now();
        const newUser = { id: tempId, name, email, password: "123", role: "PARTICIPANTE" };

        addToQueue({ type: "REGISTER", data: newUser, desc: `Cadastro: ${name}` });
        
        localUsers.push(newUser);
        populateAdminDropdowns();
        document.getElementById("admin-user-input").value = `${newUser.id} - ${newUser.name} (${newUser.email})`;
        alert("Usuário temporário criado!");
        document.getElementById("quick-name").value = "";
        document.getElementById("quick-email").value = "";
    }

    // --- FILA E SYNC ---
    function addToQueue(item) {
        syncQueue.push(item);
        saveQueue();
    }
    function saveQueue() {
        localStorage.setItem("sync_queue", JSON.stringify(syncQueue));
        renderQueue();
        updateNetworkStatus();
    }
    function renderQueue() {
        const list = document.getElementById("sync-queue-list");
        const badge = document.getElementById("sync-count");
        list.innerHTML = "";
        badge.innerText = syncQueue.length;
        badge.classList.toggle("hidden", syncQueue.length === 0);

        if(!syncQueue.length) {
            list.innerHTML = "<li class='list-group-item text-muted'>Fila vazia.</li>";
            return;
        }
        syncQueue.forEach((item, idx) => {
            let cls = item.error ? 'list-group-item-danger' : '';
            list.innerHTML += `
                <li class="list-group-item ${cls} d-flex justify-content-between">
                    <div><strong>${item.type}</strong> <small>${item.desc}</small>
                    ${item.error ? `<br><small class='text-danger'>${item.error}</small>` : ''}</div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromQueue(${idx})">X</button>
                </li>`;
        });
    }
    function removeFromQueue(i) { syncQueue.splice(i, 1); saveQueue(); }

    async function sincronizarDados() {
        if(!syncQueue.length) return;
        const btn = document.getElementById("btn-sync");
        btn.disabled = true; btn.innerText = "Sincronizando...";

        let idMap = {}; // De: temp_xxx Para: ID real
        let failed = [];
        let success = 0;

        for(const item of syncQueue) {
            try {
                // Resolver ID dependente
                if(item.dependsOnUser && idMap[item.dependsOnUser]) {
                    item.data.userId = idMap[item.dependsOnUser];
                }

                if(item.type === "REGISTER") {
                    const { id, ...payload } = item.data; 
                    const res = await fetch(`${API_URL}/users`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    if(!res.ok) throw new Error("Falha cadastro HTTP " + res.status);
                    const user = await res.json();
                    idMap[item.data.id] = user.id;
                    success++;

                } else if (item.type === "CHECKIN") {
                    // 1. Garantir Inscrição
                    // Payload: deve ser userId e eventoId (conforme RegistrationController espera, ou DTO)
                    // Se o back espera { eventoId, usuarioId } ou { eventId, userId } precisa testar. 
                    // Padrão REST costuma ser camelCase.
                    await fetch(`${API_URL}/inscricoes`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                        // Tenta mandar userId para garantir
                        body: JSON.stringify({ eventoId: parseInt(item.data.eventoId), userId: parseInt(item.data.userId) })
                    }).catch(()=>{}); // Ignora erro (provavel 400 já inscrito)

                    // 2. Registrar Presença
                    // CORREÇÃO CRÍTICA AQUI: Rota correta /presencas
                    // O Model Java Attendance espera: eventId, userId, checkedIn
                    const payloadCheckin = {
                        eventId: parseInt(item.data.eventoId),
                        userId: parseInt(item.data.userId),
                        checkedIn: true,
                        timestamp: new Date().toISOString()
                    };

                    const res = await fetch(`${API_URL}/presencas`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                        body: JSON.stringify(payloadCheckin)
                    });

                    if(!res.ok) {
                        const txt = await res.text();
                        throw new Error(`Falha checkin (${res.status}): ${txt}`);
                    }
                    success++;
                }

            } catch(err) {
                console.error(err);
                item.error = err.message;
                failed.push(item);
            }
        }

        syncQueue = failed;
        saveQueue();
        btn.disabled = false; btn.innerText = "Sincronizar";
        
        if(success > 0 && failed.length === 0) alert("Sincronização concluída!");
        else if(failed.length > 0) alert(`Terminado com ${failed.length} erros.`);
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        });
    }
</script>
</body>
</html>