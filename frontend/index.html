<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Eventos Univates</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        .loading { text-align: center; color: #666; font-style: italic; }
        .cursor-pointer { cursor: pointer; color: #0d6efd; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-5">Sistema de Eventos</h1>

    <div id="auth-screen" class="row justify-content-center">
        <div class="col-md-4">
            <div class="card p-4">
                <h3 class="text-center" id="auth-title">Login</h3>
                
                <div class="mb-3 hidden" id="name-group">
                    <label>Nome Completo</label>
                    <input type="text" id="name" class="form-control" placeholder="Seu nome">
                </div>

                <div class="mb-3">
                    <label>Email</label>
                    <input type="email" id="email" class="form-control" placeholder="user@teste.com">
                </div>
                <div class="mb-3">
                    <label>Senha</label>
                    <input type="password" id="password" class="form-control" placeholder="******">
                </div>
                
                <button onclick="handleAuth()" id="auth-btn" class="btn btn-primary w-100">Entrar</button>
                
                <p class="text-center mt-3">
                    <span id="toggle-auth" class="cursor-pointer" onclick="toggleAuthMode()">N√£o tem conta? Cadastre-se</span>
                </p>
                
                <p id="login-error" class="text-danger mt-2 text-center"></p>
            </div>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Ol√°, <span id="user-name">Participante</span>!</h4>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">Sair</button>
        </div>

        <div class="row">
            <div class="col-md-8">
                <h5>üìÖ Eventos Dispon√≠veis</h5>
                <div id="lista-eventos">
                    <p class="loading">Carregando eventos...</p>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3">
                    <h6>Seu Status</h6>
                    <p><strong>ID do Usu√°rio:</strong> <span id="user-id">-</span></p>
                    <hr>
                    <button class="btn btn-success w-100 mb-2" onclick="alert('Em breve!')">Meus Certificados</button>
                    <button onclick="carregarEventos()" class="btn btn-secondary w-100">Atualizar Lista</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "http://localhost:8080";
    
    // Estado
    let userToken = localStorage.getItem("token");
    let userId = localStorage.getItem("userId");
    let userName = localStorage.getItem("userName");
    let isLoginMode = true;

    if (userToken) mostrarDashboard();

    // --- UTILIT√ÅRIO: Decodificar JWT (Porque seu Java s√≥ manda o token) ---
    function parseJwt (token) {
        try {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
    }

    // --- CONTROLE DE TELA ---
    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById("auth-title");
        const btn = document.getElementById("auth-btn");
        const toggleLink = document.getElementById("toggle-auth");
        const nameGroup = document.getElementById("name-group");
        document.getElementById("login-error").innerText = "";

        if (isLoginMode) {
            title.innerText = "Login";
            btn.innerText = "Entrar";
            toggleLink.innerText = "N√£o tem conta? Cadastre-se";
            nameGroup.classList.add("hidden");
        } else {
            title.innerText = "Criar Nova Conta";
            btn.innerText = "Cadastrar";
            toggleLink.innerText = "J√° tenho conta. Fazer Login";
            nameGroup.classList.remove("hidden");
        }
    }

    async function handleAuth() {
        isLoginMode ? await fazerLogin() : await fazerCadastro();
    }

    // --- CADASTRO (Rota: /users) ---
    async function fazerCadastro() {
        const nome = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const errorMsg = document.getElementById("login-error");

        if (!nome || !email || !password) {
            errorMsg.innerText = "Preencha todos os campos!";
            return;
        }
        errorMsg.innerText = "Processando...";
        errorMsg.className = "text-info mt-2 text-center";

        try {
            // CORRE√á√ÉO: Endpoint agora √© /users
            const response = await fetch(`${API_URL}/users`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: nome, email: email, password: password, role: "PARTICIPANTE" })
            });

            if (response.ok) {
                alert("Cadastro realizado! Fa√ßa login.");
                toggleAuthMode();
            } else {
                throw new Error("Erro ao cadastrar (Email j√° existe?)");
            }
        } catch (error) {
            console.error(error);
            errorMsg.className = "text-danger mt-2 text-center";
            errorMsg.innerText = error.message;
        }
    }

    // --- LOGIN (Rota: /auth) ---
    async function fazerLogin() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const errorMsg = document.getElementById("login-error");

        errorMsg.innerText = "Conectando...";
        errorMsg.className = "text-info mt-2 text-center";

        try {
            // CORRE√á√ÉO: Endpoint agora √© /auth
            const response = await fetch(`${API_URL}/auth`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });

            if (!response.ok) throw new Error("Email ou senha inv√°lidos!");

            const data = await response.json(); // Retorna { "token": "..." }
            userToken = data.token;
            
            // CORRE√á√ÉO: Extrair ID e Email de dentro do Token
            const claims = parseJwt(userToken);
            if (!claims) throw new Error("Token inv√°lido recebido");

            userId = claims.id; // O Java salvou .claim("id", user.getId())
            userName = claims.sub.split('@')[0]; // Pega o come√ßo do email como nome

            localStorage.setItem("token", userToken);
            localStorage.setItem("userId", userId);
            localStorage.setItem("userName", userName);
            mostrarDashboard();

        } catch (error) {
            console.error(error);
            errorMsg.className = "text-danger mt-2 text-center";
            errorMsg.innerText = error.message;
        }
    }

    function mostrarDashboard() {
        document.getElementById("auth-screen").classList.add("hidden");
        document.getElementById("dashboard-screen").classList.remove("hidden");
        document.getElementById("user-name").innerText = userName;
        document.getElementById("user-id").innerText = userId;
        carregarEventos();
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    // --- EVENTOS E INSCRI√á√ÉO ---
    async function carregarEventos() {
        const listaDiv = document.getElementById("lista-eventos");
        listaDiv.innerHTML = '<p class="loading">Buscando dados...</p>';

        try {
            const response = await fetch(`${API_URL}/eventos`);
            const eventos = await response.json();
            listaDiv.innerHTML = ""; 

            if (eventos.length === 0) {
                listaDiv.innerHTML = "<div class='alert alert-warning'>Nenhum evento encontrado.</div>";
                return;
            }

            eventos.forEach(evento => {
                const titulo = evento.titulo || evento.title || "Sem T√≠tulo";
                const local = evento.local || "Online";
                const duracao = evento.duracaoMin || evento.carga_horaria || 0;
                const dataEvento = evento.data || "Data a definir";

                const html = `
                    <div class="card p-3 mb-3 border-start border-4 border-primary">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="fw-bold text-primary">${titulo}</h5>
                                <p class="mb-1 text-muted">üìç ${local} | ‚è±Ô∏è ${duracao} min</p>
                                <small class="text-secondary">üìÖ Data: ${dataEvento}</small>
                            </div>
                            <button class="btn btn-outline-primary" onclick="inscrever(${evento.id})">
                                Inscrever-se
                            </button>
                        </div>
                    </div>
                `;
                listaDiv.innerHTML += html;
            });
        } catch (error) {
            listaDiv.innerHTML = `<div class='alert alert-danger'>Erro ao carregar eventos.</div>`;
        }
    }

    async function inscrever(eventoId) {
        if (!confirm("Confirmar inscri√ß√£o?")) return;

        const payload = { eventoId: eventoId }; // Java pega o userId do token

        try {
            const response = await fetch(`${API_URL}/inscricoes`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${userToken}`
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert("Inscri√ß√£o realizada com sucesso! üéâ");
            } else {
                const erroTxt = await response.text();
                alert("Erro: " + erroTxt);
            }
        } catch (error) {
            alert("Erro de conex√£o.");
        }
    }
</script>

</body>
</html>